from aiogram import Router, types
from aiogram.filters import Command, CommandStart
from sqlalchemy.ext.asyncio import AsyncSession
from src.referalbot.database import repository
from src.referalbot.utils import logger
from aiogram import Bot
from src.referalbot.config import TELEGRAM_TOKEN

router = Router()
bot = Bot(token=TELEGRAM_TOKEN)

@router.message(CommandStart(deep_link=True))
async def start_with_referral(message: types.Message, command, session: AsyncSession):
    logger.info(f"–û–±—Ä–∞–±–æ—Ç–∫–∞ /start —Å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–º –∫–æ–¥–æ–º –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {message.from_user.id}")
    try:
        telegram_id = message.from_user.id
        username = message.from_user.username or "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π"
        ref_code = command.args

        if not ref_code or not ref_code.startswith("REF_"):
            await message.answer("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥.")
            return

        ref_code_clean = ref_code.replace("REF_", "")
        
        async with session.begin():
            user = await repository.get_or_create_user(session, telegram_id, username)
            inviter = await repository.get_user_by_promo_code(session, ref_code_clean)
            
            if inviter and inviter.telegram_id != telegram_id and not user.invited_by_id:
                user.invited_by_id = inviter.id
                await message.answer(
                    f"–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {username}!\n"
                    f"–í—ã –ø–æ–ª—É—á–∏–ª–∏ 5% —Å–∫–∏–¥–∫—É –ø–æ –∫–æ–¥—É {ref_code} –Ω–∞ –≤—Å–µ —É—Å–ª—É–≥–∏ Bali Love Consulting üéÅ\n\n"
                    f"üîë –í–∞—à –ø—Ä–æ–º–æ–∫–æ–¥:: {user.promo_code}\n\n"
                    f"–ü—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∂–∏—Ç–µ –µ–≥–æ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ ‚Äî –∏ —Å–∫–∏–¥–∫–∞ –±—É–¥–µ—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.\n\n"
                    f"–•–æ—á–µ—à—å –ø–æ–ª—É—á–∏—Ç—å –±–æ–ª—å—à–µ –±–æ–Ω—É—Å–æ–≤?\n"
                    f"üì≤ –ü—Ä–∏–≥–ª–∞—à–∞–π—Ç–µ –¥—Ä—É–∑–µ–π: t.me/bali_referal_bot?start=REF_{user.promo_code}"
                )
            else:
                await message.answer(
                    f"–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Bali Love, {username}!\n"
                    f"üéâ –í–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥: {user.promo_code}\n\n"
                    f"üì© –ü—Ä–∏–≥–ª–∞—à–∞–π—Ç–µ –¥—Ä—É–∑–µ–π ‚Äî –∑–∞ –∫–∞–∂–¥—É—é –∏—Ö –ø–æ–∫—É–ø–∫—É –≤—ã –ø–æ–ª—É—á–∞–µ—Ç–µ 5% –æ—Ç —Å—É–º–º—ã –Ω–∞ –±–æ–Ω—É—Å–Ω—ã–π —Å—á—ë—Ç. –ë–æ–Ω—É—Å–∞–º–∏ –º–æ–∂–Ω–æ –æ–ø–ª–∞—Ç–∏—Ç—å –ª—é–±—ã–µ —É—Å–ª—É–≥–∏ Bali Love.\n"
                    f"üí∏ –ê –≤–∞—à–∏ –¥—Ä—É–∑—å—è –ø–æ–ª—É—á–∞—Ç —Å–∫–∏–¥–∫—É –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ–±—Ä–∞—â–µ–Ω–∏–∏.\n"
                    f"–†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥ {ref_code} –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –∏–ª–∏ –≤—ã —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –∫–æ–¥."
                )
                
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ /start —Å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–º –∫–æ–¥–æ–º: {e}")
        await message.answer("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–∏.")

@router.message(CommandStart())
async def start(message: types.Message, session: AsyncSession):
    logger.info(f"–û–±—Ä–∞–±–æ—Ç–∫–∞ /start –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {message.from_user.id}")
    try:
        telegram_id = message.from_user.id
        username = message.from_user.username or "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π"
        
        async with session.begin():
            user = await repository.get_or_create_user(session, telegram_id, username)
                
        await message.answer(
            f"–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Bali Love, {username}!\n"
            f"üéâ –í–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥: {user.promo_code}\n\n"
            f"üì© –ü—Ä–∏–≥–ª–∞—à–∞–π—Ç–µ –¥—Ä—É–∑–µ–π ‚Äî –∑–∞ –∫–∞–∂–¥—É—é –∏—Ö –ø–æ–∫—É–ø–∫—É –≤—ã –ø–æ–ª—É—á–∞–µ—Ç–µ 5% –æ—Ç —Å—É–º–º—ã –Ω–∞ –±–æ–Ω—É—Å–Ω—ã–π —Å—á—ë—Ç. –ë–æ–Ω—É—Å–∞–º–∏ –º–æ–∂–Ω–æ –æ–ø–ª–∞—Ç–∏—Ç—å –ª—é–±—ã–µ —É—Å–ª—É–≥–∏ Bali Love.\n"
            f"üí∏ –ê –≤–∞—à–∏ –¥—Ä—É–∑—å—è –ø–æ–ª—É—á–∞—Ç —Å–∫–∏–¥–∫—É –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ–±—Ä–∞—â–µ–Ω–∏–∏."
        )
    
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ /start: {e}")
        await message.answer("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ /start.")

@router.message(Command("promo"))
async def get_promo(message: types.Message, session: AsyncSession):
    logger.info(f"–û–±—Ä–∞–±–æ—Ç–∫–∞ /promo –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {message.from_user.id}")
    try:
        async with session.begin():
            user = await repository.get_user_by_telegram_id(session, message.from_user.id)
        if not user:
            await message.answer("–°–Ω–∞—á–∞–ª–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start.")
            return
        await message.answer(
            f"–í–∞—à –ø—Ä–æ–º–æ–∫–æ–¥: {user.promo_code}\n"
            f"–ü—Ä–∏–≥–ª–∞—à–∞–π—Ç–µ –¥—Ä—É–∑–µ–π: t.me/bali_referal_bot?start=REF_{user.promo_code}"
        )
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ /promo: {e}")
        await message.answer("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ /promo.")

@router.message(Command("help"))
async def help_command(message: types.Message):
    logger.info(f"–û–±—Ä–∞–±–æ—Ç–∫–∞ /help –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {message.from_user.id}")
    try:
        await message.answer(
            "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n"
            "/start - –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –∏ –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥\n"
            "/promo - –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥\n"
            "/bonuses - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–æ–Ω—É—Å—ã\n"
            "/history - –ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π\n" 
            "/invite - –ü–æ–ª—É—á–∏—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É\n"
            "/help - –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ"
        )
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ /help: {e}")
        await message.answer("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ /help.")

@router.message(Command("bonuses"))
async def check_bonuses(message: types.Message, session: AsyncSession):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /bonuses.
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –±–∞–ª–∞–Ω—Å –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –±–æ–Ω—É—Å–∞–º.
    """
    logger.info(f"–û–±—Ä–∞–±–æ—Ç–∫–∞ /bonuses –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {message.from_user.id}")
    try:
        async with session.begin():
            user = await repository.get_user_by_telegram_id(session, message.from_user.id)
            if not user:
                await message.answer("–°–Ω–∞—á–∞–ª–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start.")
                return

            balance_data = await repository.get_bonus_balance(session, user.id)

        available = balance_data['available_balance']
        pending = balance_data['pending_balance']
        weekly = balance_data['weekly_earnings']
        total = balance_data['total_earned']

        response_text = (
            f"üí≥ *–í–∞—à –±–æ–Ω—É—Å–Ω—ã–π –±–∞–ª–∞–Ω—Å:*\n\n"
            f"‚úÖ –î–æ—Å—Ç—É–ø–Ω–æ –∫ —Å–ø–∏—Å–∞–Ω–∏—é: **{available:,} IDR**\n"
            f"‚è≥ –û–∂–∏–¥–∞—é—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è: **{pending:,} IDR**\n\n"
            f"üìä *–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π:*\n"
            f"–ó–∞ –ø–æ—Å–ª–µ–¥–Ω—é—é –Ω–µ–¥–µ–ª—é: **+{weekly:,} IDR**\n"
            f"–ó–∞ –≤—Å—ë –≤—Ä–µ–º—è: **+{total:,} IDR**\n\n"
            f"_–î–ª—è –≤—ã–ø–ª–∞—Ç—ã –±–æ–Ω—É—Å–æ–≤ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º._"
        )

        await message.answer(response_text, parse_mode="Markdown")

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ /bonuses: {e}")
        await message.answer("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –±–æ–Ω—É—Å–æ–≤.")

@router.message(Command("history"))
async def bonus_history(message: types.Message, session: AsyncSession):
    """
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –æ–ø–µ—Ä–∞—Ü–∏–π —Å –±–æ–Ω—É—Å–∞–º–∏.
    """
    logger.info(f"–û–±—Ä–∞–±–æ—Ç–∫–∞ /history –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {message.from_user.id}")
    try:
        async with session.begin():
            user = await repository.get_user_by_telegram_id(session, message.from_user.id)
            if not user:
                await message.answer("–°–Ω–∞—á–∞–ª–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start.")
                return

            history = await repository.get_bonus_history(session, user.id)

        if not history:
            await message.answer("–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π —Å –±–æ–Ω—É—Å–∞–º–∏ –ø—É—Å—Ç–∞.")
            return

        response_lines = ["üìú **–ü–æ—Å–ª–µ–¥–Ω–∏–µ 15 –æ–ø–µ—Ä–∞—Ü–∏–π:**\n"]
        for entry in history:
            sign = "+" if entry.amount > 0 else ""
            amount_formatted = f"{entry.amount:,}"
            date_formatted = entry.date.strftime('%d.%m.%Y')

            line = f"`{date_formatted}`: **{sign}{amount_formatted} IDR**\n_{entry.operation} ({entry.description})_"
            response_lines.append(line)

        await message.answer("\n\n".join(response_lines), parse_mode="Markdown")

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ /history: {e}")
        await message.answer("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏—Å—Ç–æ—Ä–∏–∏ –æ–ø–µ—Ä–∞—Ü–∏–π.")

@router.message(Command("invite"))
async def invite_friend(message: types.Message, session: AsyncSession):
    logger.info(f"–û–±—Ä–∞–±–æ—Ç–∫–∞ /invite –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {message.from_user.id}")
    try:
        async with session.begin():
            user = await repository.get_user_by_telegram_id(session, message.from_user.id)
        if not user:
            await message.answer("–°–Ω–∞—á–∞–ª–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start.")
            return
        await message.answer(
            f"–ü—Ä–∏–≥–ª–∞—à–∞–π—Ç–µ –¥—Ä—É–∑–µ–π: t.me/bali_referal_bot?start=REF_{user.promo_code}"
        )
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ /invite: {e}")
        await message.answer("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ /invite.")